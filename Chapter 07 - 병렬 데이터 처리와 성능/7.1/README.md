# 7.1 병렬 스트림

병렬 스트림이란 각각의 스레드에서 처리할 수 있도록 스트림 요소를 여러 청크로 분할한 스트림이다.   
따라서 병렬 스트림을 이용하면 모든 멀티코어 프로세서가 각각의 청크를 처리하도록 할당할 수 있어야 한다.

병렬 스트림을 알기 전에,   
**스트림의 여러 청크를 병렬로 처리하기 전에 병렬 스트림이 요소를 여러 청크로 분할하는 방법을 알아야한다.**

1부터 n까지 합을 더하는 예제 코드
```java
public long sequentialSum(long n) {
	return Stream.iterate(1L, i -> i + 1) // 무한 자연수 스트림 생성
                 .limit(n) // n개 이하로 제한
                 .reduce(0L, Long::sum); // 모든 숫자를 더하는 리듀싱 연산
}
```
**이 코드에서 n이 커지면 연산을 병렬로 처리하는 것이 좋을 것이다.**

병렬로 처리하기 위해서 다음과 같은 고민이 필요하다.

1. 어떻게 동기화해야 할까? [이슈](https://github.com/java-piledrivers/modern-java-in-action/issues/12#issuecomment-1515464287)
2. 몇개의 스레드를 사용해야할까?
3. 숫자는 어떻게 생성할까?
4. 생성된 숫자는 누가 더할까?

자바의 병렬 스트림을 이용하면 위 문제를 고민하지 않아도 된다.

##  병렬 스트림이 요소를 여러 청크로 분할하는 방법

병렬로 처리하는 1부터 n까지 합을 더하는 예제 코드
```java
public long sequentialSum(long n) {
	return Stream.iterate(1L, i -> i + 1) 
                 .limit(n) 
                 .parallel() // 스트림을 병렬 스트림으로 전환
                 .reduce(0L, Long::sum); 
}
```
이전 코드와 다른 점은 스트림이 여러 청크로 분할되어 있다는 점이다.   
`parallel()` 을 추가하면 위 리듀싱 연산이 여러 청크로 분할되어진다.   

리듀싱 연산이 여러 청크로 분할되어 진다는 것은 아래 그림처럼   
리듀싱 연산 자체를 나누어서 결과를 마지막에 다시 리듀싱한다는것이다.   

그림에서 `n = 8` 이다.

![2023-04-20_07-40-52](https://user-images.githubusercontent.com/59721293/233215430-d93c0a57-671d-4d3e-a813-1a7e91980e13.jpg)

todo: 244p 부터 계속 작성


